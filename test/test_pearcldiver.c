#include "../src/lib/pearcldiver.h"
#include "../src/lib/PearlDiver.h"
#include "../src/lib/util/converter.h"

#include "cunit_include.h"
#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include <assert.h>
#include <string.h>
#include <unistd.h>

#define SIZE_IN_BYTES  49
#ifndef TRYTE_NINES
#endif
//#define TRYTE_NINES "999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999"
#define TRYTE_NINESE "A99C9999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999A"
typedef long trit_t;

static int init_suite(void) {
	fprintf(stderr, "I: initializing converter...");
	init_converter();
	fprintf(stderr, "done.\n");
	//pdcl = malloc(sizeof(PearCLDiver));
	return 0;
}
static int clean_suite(void) {
	//free(pdcl);
	return 0;
}
static void init_cl_test(void) {
}
static void teardown_cl_test(void) {
	//memset(pdcl,0,sizeof(PearCLDiver));
}

static bool is_valid_hash(trit_t *const trits ) {
        char *hash = bytes(trits, TRANSACTION_LENGTH);
        if (hash[SIZE_IN_BYTES - 4] != 0 || hash[SIZE_IN_BYTES - 3] != 0 || hash[SIZE_IN_BYTES - 2] != 0 || hash[SIZE_IN_BYTES - 1] != 0) {
			return false;
        }
		return true;
}

static void test_init_kernel(void) {
	PearCLDiver pdcl;
	init_pearcl(&pdcl);
}

static void test_search(void) {
	int mwm; 
	double time_per_cycle;
	clock_t begin, end;
	char trytes[TRYTE_LENGTH] = TRYTE_NINESE;
	PearCLDiver pdcl;
	init_pearcl(&pdcl);
	trit_t trits[TRANSACTION_LENGTH];
	//memset(trits,0,sizeof(trit_t)*TRANSACTION_LENGTH);
	//trits = malloc(sizeof(TRANSACTION_LENGTH));
	trytes2trits(trits, trytes, TRANSACTION_LENGTH/3);

	//memcpy(trits,rand_trits,TRANSACTION_LENGTH);
	begin = clock();
	for(mwm=1; mwm<HASH_LENGTH; mwm++) {
		//fprintf(stderr, "Starting mwm %d\n", mwm);
		pearcl_search(&pdcl, trits, TRANSACTION_LENGTH, mwm);
		CU_ASSERT(pdcl.pd.nonceFound);
		CU_ASSERT_FATAL(is_valid_hash(trits));
	}
	end = clock();
	trits2trytes(trytes, trits, TRANSACTION_LENGTH);
	//puts(trytes);
	time_per_cycle = (double)(end - begin) / CLOCKS_PER_SEC;
	fprintf(stderr, "time_per_cycle: %f\n", time_per_cycle);
}

static CU_TestInfo tests[] = {
	{"Test Init CL Kernels", test_init_kernel},
	{"Test Search ", test_search},
	CU_TEST_INFO_NULL,
};

static CU_SuiteInfo suites[] = {
	{ "CLContext Test Suite", init_suite, clean_suite, init_cl_test,teardown_cl_test, tests },
	CU_SUITE_INFO_NULL,
};

//ADD_SUITE(suites);

int main() {
	return run_tests(suites);
}
