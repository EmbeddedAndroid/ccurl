#include "acunit/i.h"
#ifdef __APPLE__
#include "CUnit/CUnit.h"
#include "CUnit/Basic.h"
#else
#include "BCUnit/BCUnit.h"
#include "BCUnit/Basic.h"
#endif
#include "../src/Hash.h"
#include "../src/Curl.h"
#include "random_trits.h"
#include <stdio.h>
#include <string.h>

static const int length_2 = 243*3;
static const long trits_2[STATE_LENGTH] = {-1, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 0, -1, 0, 0, -1, -1, 0, -1, 0, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, -1, 0, -1, 0, 0, -1, 0, 0, -1, 0, -1, -1, 0, 0, -1, -1, 0, -1, -1, -1, -1, 0, -1, -1, -1, -1, 0, -1, 0, 0, -1, -1, 0, 0, -1, 0, -1, 0, 0, -1, -1, -1, -1, 0, -1, -1, 0, -1, 0, -1, 0, -1, -1, -1, -1, 0, 0, 0, 0, 0, -1, 0, 0, 0, 0, -1, 0, -1, -1, 0, 0, 0, -1, -1, 0, -1, -1, -1, 0, -1, 0, -1, 0, -1, 0, 0, -1, 0, -1, -1, -1, -1, 0, 0, -1, -1, 0, -1, -1, 0, 0, 0, 0, 0, 0, -1, 0, 0, -1, -1, -1, 0, -1, 0, 0, 0, -1, -1, -1, 0, -1, 0, 0, 0, -1, -1, -1, -1, -1, -1, -1, 0, 0, -1, -1, -1, 0, -1, -1, -1, 0, -1, 0, 0, -1, 0, -1, 0, 0, 0, 0, -1, -1, 0, 0, 0, 0, -1, -1, -1, -1, 0, 0, 0, 0, 0, -1, -1, -1, -1, -1, 0, 0, -1, 0, 0, -1, -1, -1, 0, -1, 0, -1, 0, -1, 0, -1, 0, 0, -1, -1, 0, -1, -1, -1, 0, 0, -1, -1, 0, -1, -1, -1, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, -1, -1, 0, -1, 0, -1, -1, 0, -1, -1, -1, 0, 0, 0, 0, 0, -1, -1, 0, -1, -1, 0, 0, 0, -1, 0, 0, -1, 0, 0, -1, 0, -1, -1, -1, 0, -1, -1, 0, -1, 0, 0, -1, 0, 0, -1, -1, 0, -1, -1, 0, -1, -1, -1, 0, -1, -1, -1, -1, 0, 0, -1, -1, 0, 0, 0, -1, 0, 0, 0, 0, -1, -1, -1, -1, -1, 0, -1, -1, -1, -1, 0, 0, 0, 0, 0, -1, -1, -1, -1, -1, -1, -1, -1, 0, 0, -1, -1, -1, 0, 0, -1, -1, 0, -1, 0, -1, -1, -1, 0, 0, 0, 0, -1, 0, -1, -1, 0, 0, 0, 0, -1, 0, 0, -1, -1, 0, 0, 0, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, -1, -1, -1, -1, -1, -1, 0, -1, -1, 0, 0, -1, -1, 0, 0, -1, 0, 0, 0, -1, -1, 0, 0, -1, 0, -1, -1, 0, 0, 0, 0, 0, 0, 0, 0, -1, 0, -1, 0, 0, 0, -1, -1, 0, 0, -1, 0, -1, -1, 0, 0, 0, 0, -1, 0, -1, -1, -1, -1, -1, 0, -1, 0, 0, 0, -1, -1, -1, -1, -1, -1, 0, 0, -1, -1, 0, 0, 0, -1, -1, 0, -1, -1, 0, 0, 0, -1, 0, -1, 0, 0, -1, 0, -1, 0, 0, 0, -1, 0, 0, -1, -1, -1, 0, -1, 0, -1, -1, 0, 0, -1, 0, -1, -1, 0, 0, 0, -1, 0, 0, -1, -1, 0, -1, -1, -1, 0, 0, -1, -1, -1, 0, -1, 0, 0, -1, -1, -1, -1, 0, 0, -1, -1, 0, -1, 0, -1, -1, 0, -1, 0, -1, 0, -1, -1, -1, -1, 0, 0, 0, 0, -1, 0, 0, 0, 0, -1, -1, 0, -1, 0, 0, -1, 0, 0, 0, 0, 0, 0, -1, -1, -1, 0, 0, -1, 0, -1, 0, 0, -1, 0, -1, 0, -1, 0, -1, -1, 0, 0, -1, -1, -1, 0, 0, -1, 0, 0, -1, 0, -1, 0, 0, 0, 0, 0, 0, -1, -1, 0, -1, -1, -1, 0, 0, 0, -1, 0, -1, -1, -1, 0, 0, -1, -1, 0, -1, 0, 0, 0, 0, -1, -1, -1, -1, 0, 0, 0, -1, -1, -1, -1, 0, 0, -1, 0, -1, -1, 0, 0, -1, -1, -1, -1, 0, -1, 0, 0, 0, 0, -1, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, -1, 0, -1, 0, 0, -1, 0, -1, -1, 0, 0, -1, 0, -1, -1, -1, 0, -1, 0, -1, 0, -1, 0, -1, 0, 0, -1, -1, 0, -1, 0, -1, -1, 0, -1, -1, -1, -1, 0, 0, 0, -1, 0, 0, -1, 0};
static const long expect_2[STATE_LENGTH] = {0, -1, -1, -1, -1, -1, 1, 1, -1, 0, 0, 1, 1, 0, 1, -1, -1, 1, 0, 0, 0, 1, -1, 0, 0, -1, 0, 1, 0, -1, 1, 0, -1, -1, 1, 1, 0, 0, -1, 0, 0, -1, 0, 1, -1, 0, 1, 0, 0, 0, 0, -1, -1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, -1, 1, -1, 0, 1, 1, 0, 1, -1, 0, 0, 0, 0, 1, -1, 1, -1, 1, -1, 0, 1, -1, 0, 1, -1, 1, -1, 0, 1, 0, 0, 0, -1, -1, 0, -1, -1, 0, 1, -1, 0, 1, 0, 1, 0, -1, -1, 1, 1, -1, 0, -1, 1, 1, 1, -1, 1, 1, 1, -1, 1, -1, 0, -1, 1, -1, -1, 0, 0, 0, 1, -1, -1, -1, 1, -1, 0, 1, -1, 1, 0, 1, 0, -1, 1, -1, -1, -1, 1, -1, -1, 1, -1, 0, 1, 1, 1, 0, 1, -1, -1, 1, 1, 0, -1, 0, 1, 0, 0, 0, -1, 0, 1, 1, 0, 1, 1, 1, -1, 0, 0, 1, 1, 0, -1, -1, -1, 1, 0, -1, -1, -1, 1, 1, 0, 0, 0, -1, 1, 1, 1, -1, 0, 1, -1, -1, -1, -1, 1, 1, -1, -1, 0, 1, 0, -1, -1, -1, 1, 0, 0, -1, 0, 1, -1, 0, 0, 0, 1, 0, 1, 1, -1, 1, 0, -1, 0, 1, 1, 0, -1, 0, -1, 1, -1, 1, 0, -1, 1, 1, -1, 0, 0, -1, 0, 1, 1, 0, 1, -1, -1, 0, 1, 0, 1, -1, 1, -1, 1, -1, 0, 1, -1, -1, -1, 1, 1, 0, 0, -1, 1, 1, 0, 0, 0, 1, 0, -1, 0, 0, 1, -1, -1, -1, -1, 0, -1, 1, -1, 1, -1, 1, 0, 0, -1, -1, 0, 0, 0, 1, -1, 1, 0, 1, -1, -1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, -1, -1, 0, -1, -1, -1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 1, -1, 0, 1, 0, 1, -1, -1, 1, -1, 0, 1, -1, 0, -1, 1, 1, 0, -1, -1, 0, 1, 0, 0, 0, 1, -1, -1, 1, -1, -1, 1, 1, 0, 0, 0, -1, 1, 1, 0, 0, 1, -1, 1, 0, 0, 1, 0, 1, 1, 0, 0, -1, 0, -1, 1, -1, 0, -1, -1, 1, 0, -1, -1, 0, 0, -1, 0, -1, 1, -1, 1, 1, 1, 0, -1, -1, -1, 1, 0, 0, 1, 0, -1, 1, 1, 0, -1, 1, 1, 0, 1, -1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, -1, 1, -1, 1, 1, 1, 0, 0, 1, -1, 1, 1, -1, 0, -1, -1, 1, -1, 1, -1, -1, 1, -1, -1, 1, 1, -1, 0, 0, 1, 0, -1, 1, 0, 1, -1, -1, 0, 0, 0, 1, 1, 1, -1, 0, -1, -1, -1, 0, 0, 0, 1, 0, 1, 1, 0, 1, -1, -1, 0, 0, 0, -1, -1, 1, 0, 1, 0, -1, -1, -1, 0, -1, 0, -1, 0, -1, -1, -1, 0, -1, -1, 0, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, -1, 1, 0, 0, 0, -1, 1, 1, 1, -1, -1, 1, 0, 0, 1, 1, 1, 0, -1, 1, -1, -1, 1, 0, -1, -1, 1, 1, -1, 0, -1, 0, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, -1, -1, 1, 0, 0, 1, 1, -1, 1, 0, 1, -1, 1, -1, -1, 1, 1, 0, 0, -1, 1, -1, 0, -1, 0, 1, -1, 0, 1, -1, -1, 0, 0, -1, 0, 1, 1, 0, 1, -1, 1, 1, 0, 1, 1, 0, -1, 1, 0, 0, 0, 1, 0, -1, -1, 0, 0, 1, 1, 0, 0, 0, 0, -1, -1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 0, -1, 0, 1, -1, 1, 1, -1, 1, -1, 0, 0, 0, -1, 0, 0, -1, 1, -1, -1, -1, -1, -1, 1, -1, -1, 1, -1, 1, 0, -1, -1, 0, -1, 0, 1, -1, 1, 1, -1, 1, -1, -1, 1, -1, -1, 0, 0, 0, -1, 1, 1, -1, -1, 1, 0, -1, -1, 0};

int init_suite(void) {return 0;}
int clean_suite(void) {return 0;}

void test_curl_absorb(void);


void test_curl_absorb(void) {
	long my_trits_2[length_2], exp_trits_2[length_2];

	Curl ctx;
       	init_curl(&ctx);
	memcpy(my_trits_2, trits_2, length_2 * sizeof(long));

	absorb(&ctx, my_trits_2, 0,length_2);
	squeeze(&ctx, my_trits_2,0,length_2);
	CU_ASSERT(memcmp(my_trits_2, exp_trits_2, length_2 * sizeof(long)));
}

void test_curl_reset() {

	signed long my_trits_2[length_2];

	Curl ctx;
       	init_curl(&ctx);

	memcpy(my_trits_2, trits_2, length_2 * sizeof(long));

	absorb(&ctx, my_trits_2,0,length_2);
	squeeze(&ctx, my_trits_2,0,length_2);
	CU_ASSERT(memcmp(my_trits_2, expect_2, length_2 * sizeof(long)));

	reset(&ctx);
	memcpy(my_trits_2, trits_2, length_2 * sizeof(long));

	absorb(&ctx, my_trits_2,0,length_2);
	squeeze(&ctx, my_trits_2,0,length_2);
	CU_ASSERT(memcmp(my_trits_2, expect_2, length_2 * sizeof(long)));

}

void test_curl_noreset_fail() {
	signed long my_trits_2[length_2];

	Curl ctx;
       	init_curl(&ctx);
	memcpy(my_trits_2, trits_2, length_2 * sizeof(long));
	memcpy(my_trits_2, trits_2, length_2 * sizeof(long));

	absorb(&ctx, my_trits_2,0,length_2);
	squeeze(&ctx, my_trits_2,0,length_2);
	CU_ASSERT(memcmp(my_trits_2, expect_2, length_2 * sizeof(long)));

	int length = HASH_LENGTH;
	absorb(&ctx, my_trits_2,0,length);
	squeeze(&ctx, my_trits_2,0,length);
	CU_ASSERT_FATAL(memcmp(my_trits_2, expect_2, HASH_LENGTH * sizeof(long)));
}

static CU_TestInfo tests[] = {
	{"Curl Absorb Test", test_curl_absorb},
	{"Curl Reset Test", test_curl_reset},
	{"Curl NoReset Fail Test", test_curl_noreset_fail},
	CU_TEST_INFO_NULL,
};

static CU_SuiteInfo suites[] = {
	{ "suitename1", init_suite, clean_suite, NULL, NULL, tests },
	CU_SUITE_INFO_NULL,
};

ADD_SUITE(suites);
